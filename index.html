<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‰ä¼Šå¡å“‡ x COMP1101 è¨ä¼æˆ°</title>
    <style>
        /* --- 1. å…¨å±€è¨­å®šèˆ‡ Chiikawa é…è‰² --- */
        :root {
            --primary-green: #58cc02;
            --primary-shadow: #58a700;
            --wrong-red: #ff4b4b;
            --bg-cream: #fff9e6; /* å‰ä¼Šå¡å“‡ç±³è‰²èƒŒæ™¯ */
            --chiikawa-pink: #ffdae0;
            --hachiware-blue: #dceeff;
            --usagi-yellow: #fff3b8;
            --text-dark: #4b4b4b;
            --font-main: "M Plus Rounded 1c", "Varela Round", "Heiti TC", sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: #f0f0f0; /* é›»è…¦ç‰ˆèƒŒæ™¯ç¨æ·±ï¼Œçªå‡ºä¸­é–“çš„ App */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-dark);
            overflow: hidden; /* é˜²æ­¢æ»¾å‹• */
        }

        /* --- 2. éŸ¿æ‡‰å¼å®¹å™¨ (æ‰‹æ©Ÿ/iPad/é›»è…¦é©é…) --- */
        #app-container {
            width: 100%;
            height: 100%;
            max-width: 500px; /* æ‰‹æ©Ÿå¯¬åº¦é™åˆ¶ */
            max-height: 900px; /* æ¨¡æ“¬æ‰‹æ©Ÿé«˜åº¦ */
            background: var(--bg-cream);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* é›»è…¦å’Œ iPad ä¸Šçš„å„ªåŒ– */
        @media (min-width: 600px) {
            #app-container {
                height: 90vh;
                border-radius: 20px;
                border: 4px solid #fff;
            }
        }

        /* --- 3. å ´æ™¯åˆ‡æ› (View System) --- */
        .view {
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            align-items: center;
        }

        .view.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 4. é¦–é  (Home View) --- */
        #home-view {
            justify-content: center;
            text-align: center;
            background: linear-gradient(180deg, var(--bg-cream) 0%, white 100%);
        }

        .logo-area {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .title {
            font-size: 28px;
            font-weight: 800;
            color: #ff8e8e;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px white;
        }

        .subtitle {
            font-size: 16px;
            color: #888;
            margin-bottom: 40px;
        }

        /* --- 5. æŒ‰éˆ•æ¨£å¼ --- */
        .btn-primary {
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            width: 80%;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--primary-shadow);
            margin-bottom: 15px;
            transition: transform 0.1s;
        }

        .btn-secondary {
            background-color: var(--hachiware-blue);
            color: #0076c0;
            border: 2px solid #bce0fd;
            border-radius: 16px;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            width: 80%;
            cursor: pointer;
            box-shadow: 0 4px 0 #a3d4fc;
        }

        .btn-primary:active, .btn-secondary:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* --- 6. éŠæˆ²ä»‹é¢ (Game View) --- */
        header {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .progress-bar-bg {
            flex-grow: 1;
            background: #e5e5e5;
            height: 16px;
            border-radius: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary-green);
            width: 0%;
            border-radius: 8px;
            transition: width 0.3s;
        }

        .character-box {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
        }

        .mascot { font-size: 60px; }
        
        .speech-bubble {
            background: white;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #eee;
            flex-grow: 1;
            font-weight: bold;
            position: relative;
        }
        
        .speech-bubble::before {
            content: ''; position: absolute; left: -10px; top: 50%;
            border-width: 10px 10px 10px 0; border-style: solid;
            border-color: transparent #eee transparent transparent;
            transform: translateY(-50%);
        }

        .options-grid { width: 100%; display: flex; flex-direction: column; gap: 10px; }
        
        .option-btn {
            background: white; border: 2px solid #eee; padding: 15px;
            border-radius: 12px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 0 #eee; text-align: left;
        }
        
        .option-btn.selected { background: #ddf4ff; border-color: #84d8ff; color: #1cb0f6; }
        .option-btn.correct { background: #d7ffb8; border-color: #58cc02; color: #58cc02; }
        .option-btn.wrong { background: #ffdfe0; border-color: #ff4b4b; color: #ff4b4b; }

        .footer-action {
            margin-top: auto; width: 100%; padding-top: 20px;
            display: none; flex-direction: column; gap: 10px;
        }

        /* --- 7. æ’è¡Œæ¦œ (Leaderboard View) --- */
        #leaderboard-view {
            background: var(--usagi-yellow);
        }

        .rank-list {
            width: 100%;
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
            max-height: 60vh;
            overflow-y: auto;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }
        
        .rank-item:last-child { border-bottom: none; }
        
        .rank-num {
            width: 30px; height: 30px; border-radius: 50%;
            background: #eee; display: flex; align-items: center; justify-content: center;
            margin-right: 10px;
        }

        /* å‰ä¸‰åç‰¹åˆ¥è‰² */
        .rank-item:nth-child(1) .rank-num { background: #ffd700; color: #b45f06; } /* é‡‘ */
        .rank-item:nth-child(2) .rank-num { background: #c0c0c0; color: #555; }    /* éŠ€ */
        .rank-item:nth-child(3) .rank-num { background: #cd7f32; color: #fff; }    /* éŠ… */

        .back-btn {
            position: absolute; top: 15px; left: 15px;
            background: transparent; border: none; font-size: 24px; cursor: pointer;
        }

        /* --- è¼¸å…¥åå­—è¦–çª— --- */
        #name-input-modal {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            justify-content: center; align-items: center;
        }
        
        .modal-content {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; width: 80%;
        }

        input[type="text"] {
            width: 100%; padding: 10px; margin: 15px 0;
            border: 2px solid #eee; border-radius: 10px; font-size: 18px;
            box-sizing: border-box;
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

<div id="app-container">

    <div id="home-view" class="view active">
        <div class="logo-area">ğŸ¹</div>
        <div class="title">COMP1101<br>è¨ä¼å¤§ä½œæˆ°</div>
        <div class="subtitle">ç‚ºäº†å­¸åˆ†ï¼Œä¸€èµ·å»è¨ä¼æ€ªç¸å•¦ï¼</div>
        
        <button class="btn-primary" onclick="startGame()">é–‹å§‹è¨ä¼</button>
        <button class="btn-secondary" onclick="showLeaderboard()">è‹±é›„æ¦œ</button>
        
        <div style="margin-top:30px; font-size:12px; color:#aaa;">
            Made by å‰ä¼Šå¡å“‡ç²‰çµ²åœ˜
        </div>
    </div>

    <div id="game-view" class="view">
        <header>
            <div style="font-size:24px; cursor:pointer;" onclick="goHome()">âœ•</div>
            <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress"></div></div>
            <div style="color:#ff4b4b; font-weight:bold;">â¤ï¸ <span id="lives">5</span></div>
        </header>

        <div class="character-box">
            <div class="mascot" id="mascot">ğŸ±</div>
            <div class="speech-bubble" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
        </div>

        <div class="options-grid" id="options-area"></div>

        <div class="footer-action" id="footer-action">
            <div id="feedback-msg" style="font-weight:bold; padding:0 10px;"></div>
            <button class="btn-primary" id="next-btn" style="width:100%;">ç¹¼çºŒ</button>
        </div>
    </div>

    <div id="leaderboard-view" class="view">
        <button class="back-btn" onclick="goHome()">â¬…ï¸</button>
        <h2 style="color:#5d4037;">ğŸ† è¨ä¼è‹±é›„æ¦œ ğŸ†</h2>
        <div class="rank-list" id="rank-list">
            <div style="padding:20px; text-align:center;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="name-input-modal">
        <div class="modal-content">
            <h2>è¨ä¼å®Œæˆï¼</h2>
            <p>å¾—åˆ†ï¼š<span id="final-score">0</span></p>
            <input type="text" id="player-name" placeholder="è¼¸å…¥ä½ çš„åå­—" maxlength="10">
            <button class="btn-primary" onclick="submitScore()">ä¸Šå‚³æˆ°ç¸¾</button>
        </div>
    </div>

</div>

<script type="module">
    // Import SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB2LWHNU2tdD1MG7yfH5fJx2jvLG0Xl__A",
        authDomain: "comp-sem-1.firebaseapp.com",
        projectId: "comp-sem-1",
        storageBucket: "comp-sem-1.firebasestorage.app",
        messagingSenderId: "443718115938",
        appId: "1:443718115938:web:2ef05353a59b47869fe73b",
        measurementId: "G-75MJKF79JJ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Game Logic Variables ---
    let currentQ = 0;
    let score = 0;
    let lives = 5;
    let gameActive = false;
    
    // é€™è£¡æ”¾å…¥éƒ¨åˆ†é¡Œç›®ä½œç‚ºç¯„ä¾‹ (ä½ å¯ä»¥ä¹‹å¾ŒæŠŠ52é¡Œå…¨éƒ¨æ”¾é€²å»)
    const questions = [
        { q: "Internet æ˜¯ä¸€å€‹å…¨çƒå„åœ°ç¶²è·¯çš„é›†åˆé«”ï¼Œå®ƒé€£çµæ•¸ä»¥ç™¾è¬è¨ˆçš„æ©Ÿæ§‹èˆ‡å€‹äººã€‚", opts: ["Internet", "Telnet", "Web", "NSFNet"], a: 0 },
        { q: "æœ‰äº›å¤–å¯„éƒµä»¶ä¼ºæœå™¨æ¡ç”¨çš„å‚³è¼¸å”å®šæ˜¯ï¼Ÿ", opts: ["SMTP", "ARPA", "POP", "HTML"], a: 0 },
        { q: "Linux ä½œæ¥­ç³»çµ±æ˜¯å±¬æ–¼ä¸‹åˆ—å“ªä¸€ç¨®é¡å‹ï¼Ÿ", opts: ["å–®äººå–®å·¥", "å–®äººå¤šå·¥", "å¤šäººå–®å·¥", "å¤šäººå¤šå·¥"], a: 3 },
        { q: "é˜²ç«ç‰†(Firewall)çš„ä¸»è¦åŠŸèƒ½æ˜¯ä»€éº¼ï¼Ÿ", opts: ["å„²å­˜æ•¸æ“š", "é˜²æ­¢æœªæˆæ¬Šè¨ªå•", "æä¾›ç¶²çµ¡é€£æ¥", "ç€è¦½ç¶²é "], a: 1 },
        { q: "1TB ç¡¬ç¢Ÿå®¹é‡æ˜¯ 250GB çš„å¹¾å€ï¼Ÿ", opts: ["4", "40", "400", "4000"], a: 0 }
    ];

    // --- Global Functions attached to Window (for HTML onclick) ---
    window.startGame = () => {
        currentQ = 0;
        score = 0;
        lives = 5;
        gameActive = true;
        document.getElementById('lives').innerText = lives;
        switchView('game-view');
        loadQuestion();
    };

    window.goHome = () => {
        gameActive = false;
        switchView('home-view');
    };

    window.showLeaderboard = async () => {
        switchView('leaderboard-view');
        const list = document.getElementById('rank-list');
        list.innerHTML = '<div style="padding:20px; text-align:center;">è¼‰å…¥æ•¸æ“šä¸­... ğŸ°</div>';
        
        try {
            const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(20));
            const querySnapshot = await getDocs(q);
            
            let html = "";
            let rank = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                html += `
                    <div class="rank-item">
                        <div style="display:flex; align-items:center;">
                            <div class="rank-num">${rank++}</div>
                            <div>${escapeHtml(data.name)}</div>
                        </div>
                        <div style="color:var(--primary-green);">${data.score}åˆ†</div>
                    </div>
                `;
            });

            if(html === "") html = '<div style="padding:20px; text-align:center;">ä»²æœªæœ‰äººæŒ‘æˆ°å–”ï¼</div>';
            list.innerHTML = html;
        } catch (e) {
            console.error("Error:", e);
            list.innerHTML = '<div style="padding:20px; text-align:center; color:red;">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– Firebase è¨­å®šã€‚</div>';
        }
    };

    window.submitScore = async () => {
        const nameInput = document.getElementById('player-name');
        const name = nameInput.value.trim() || "ç„¡åå‰ä¼Š";
        
        const btn = document.querySelector('#name-input-modal button');
        btn.innerText = "ä¸Šå‚³ä¸­...";
        btn.disabled = true;

        try {
            await addDoc(collection(db, "leaderboard"), {
                name: name,
                score: score,
                timestamp: serverTimestamp()
            });
            document.getElementById('name-input-modal').style.display = 'none';
            btn.innerText = "ä¸Šå‚³æˆ°ç¸¾";
            btn.disabled = false;
            showLeaderboard(); // Go to leaderboard after submit
        } catch (e) {
            alert("ä¸Šå‚³å¤±æ•—: " + e.message);
            btn.innerText = "ä¸Šå‚³æˆ°ç¸¾";
            btn.disabled = false;
        }
    };

    // --- Internal Logic ---
    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    function loadQuestion() {
        if (currentQ >= questions.length) {
            endGame();
            return;
        }

        const q = questions[currentQ];
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('mascot').innerText = "ğŸ±"; // Hachiware
        document.getElementById('footer-action').style.display = 'none';
        
        // Update Progress
        const pct = (currentQ / questions.length) * 100;
        document.getElementById('progress').style.width = pct + '%';

        // Options
        const area = document.getElementById('options-area');
        area.innerHTML = '';
        q.opts.forEach((opt, idx) => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(idx, btn, q.a);
            area.appendChild(btn);
        });
    }

    function checkAnswer(selectedIdx, btn, correctIdx) {
        // Disable all clicks
        const allBtns = document.querySelectorAll('.option-btn');
        allBtns.forEach(b => b.style.pointerEvents = 'none');

        const footer = document.getElementById('footer-action');
        const msg = document.getElementById('feedback-msg');
        footer.style.display = 'flex';

        if (selectedIdx === correctIdx) {
            btn.classList.add('correct');
            document.getElementById('mascot').innerText = "ğŸ¹"; // Happy Chiikawa
            msg.innerText = "å¥½é‡ï¼ç­”å•±å·¦ï¼";
            msg.style.color = "green";
            score++;
        } else {
            btn.classList.add('wrong');
            allBtns[correctIdx].classList.add('correct'); // Show answer
            document.getElementById('mascot').innerText = "ğŸ˜­"; // Crying
            msg.innerText = "å“å‘€...ç­”éŒ¯å·¦";
            msg.style.color = "red";
            lives--;
            document.getElementById('lives').innerText = lives;
        }

        document.getElementById('next-btn').onclick = () => {
            if (lives <= 0) {
                endGame();
            } else {
                currentQ++;
                loadQuestion();
            }
        };
    }

    function endGame() {
        document.getElementById('final-score').innerText = score + " / " + questions.length;
        document.getElementById('name-input-modal').style.display = 'flex';
    }

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

</script>

</body>
</html>
